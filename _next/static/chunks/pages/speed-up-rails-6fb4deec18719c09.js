(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[976],{7881:function(e,s,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/speed-up-rails",function(){return r(5746)}])},5746:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return d}});var n=r(5893),i=r(3344),l=r(2165),t=(r(8142),r(7890)),c=function(e){var s=e.name;return(0,n.jsx)("label",{className:"checkbox-wrapper",children:(0,n.jsx)("input",{type:"checkbox",name:s})})},a=function(e){!function(e){for(var s=arguments.length,r=new Array(s>1?s-1:0),n=1;n<s;n++)r[n-1]=arguments[n];r.forEach((function(s){e.srcElement.classList.toggle(s,e.currentSlide.classList.contains(s))}))}(e,"problem","tool","optimization")};function d(){return(0,n.jsxs)(i.A,{handleSlideChanged:a,children:[(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h1",{children:"Speed Up Rails"}),(0,n.jsx)("h2",{children:"@tian_im"})]}),(0,n.jsx)(h,{}),(0,n.jsx)(o,{}),(0,n.jsx)(u,{}),(0,n.jsx)(j,{}),(0,n.jsx)(x,{}),(0,n.jsx)(f,{})]})}var h=function(){return(0,n.jsxs)(t.M,{children:[(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"How Performance is Ranked"})}),(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Classify Tasks"})}),(0,n.jsx)(t.M,{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"Bugs"}),(0,n.jsx)("li",{children:"Features"}),(0,n.jsxs)("li",{children:["Tech Debts",(0,n.jsx)("div",{className:"fragment fade-in",children:(0,n.jsx)("small",{children:"\u2191 Performance issues"})})]})]})}),(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Code Quality"})}),(0,n.jsx)(t.M,{children:(0,n.jsx)("img",{src:"save-our-rails/code-quality-radar.png"})}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"Performance Degrades"}),(0,n.jsx)("small",{children:"(same as test coverage)"})]}),(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Take It Seriously!"})}),(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Before It Becomes a Problem"})}),(0,n.jsx)(t.M,{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"Server crashes"}),(0,n.jsx)("li",{children:"Raise funds, esp. before IPO"})]})})]})},o=function(){return(0,n.jsxs)(t.M,{children:[(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Understand the Performance"})}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"The No.1 Enemy"}),(0,n.jsx)("h2",{className:"fragment fade-in",children:(0,n.jsx)("b",{children:"Repetition"})}),(0,n.jsx)(l.I,{children:"pry(main)> puts Benchmark.measure { 1_000_000.times { a = '' } }\n  0.134198   0.020083   0.154281 (  0.154829)\n=> nil"})]}),(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"What is Slow?"})}),(0,n.jsx)(t.M,{children:(0,n.jsxs)("ul",{className:"plain",children:[(0,n.jsxs)("li",{children:[(0,n.jsx)(c,{}),"Ruby"]}),(0,n.jsxs)("li",{children:[(0,n.jsx)(c,{}),"Rails"]}),(0,n.jsxs)("li",{children:[(0,n.jsx)(c,{}),"Database queries"]}),(0,n.jsxs)("li",{children:[(0,n.jsx)(c,{}),"All of Above"]})]})}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"IO is Slow!"}),(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"File IO"}),(0,n.jsxs)("li",{children:["Network IO",(0,n.jsx)("div",{children:(0,n.jsx)("small",{children:"Database queries, API requests"})})]})]})]}),(0,n.jsx)(m,{}),(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Key Areas"})}),(0,n.jsx)(t.M,{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"ActiveRecord"}),(0,n.jsx)("li",{children:"Database Statement"}),(0,n.jsx)("li",{children:"GraphQL"}),(0,n.jsx)("li",{className:"fragment fade-out","data-fragment-index":"2",children:"Database Schema"}),(0,n.jsx)("li",{className:"fragment fade-out","data-fragment-index":"2",children:"Ruby: Object Allocation and Garbage Collect"}),(0,n.jsx)("li",{className:"fragment fade-out","data-fragment-index":"2",children:"Rails"}),(0,n.jsx)("li",{className:"fragment fade-out","data-fragment-index":"2",children:"Hierarchy"})]})})]})},u=function(){return(0,n.jsxs)(t.M,{children:[(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"ActiveRecord"})}),(0,n.jsxs)(g,{children:[(0,n.jsx)("h2",{children:"Backtrace display"}),(0,n.jsx)("small",{children:"(find out where the DB query was triggered)"})]}),(0,n.jsxs)(g,{children:[(0,n.jsxs)("h2",{children:["Gem ",(0,n.jsx)("b",{children:"active_record_query_trace"})]}),(0,n.jsx)("img",{src:"/save-our-rails/active_record_query_trace.png"}),(0,n.jsxs)("small",{children:["(see ",(0,n.jsx)("a",{href:"https://github.com/brunofacca/active-record-query-trace",children:"active-record-query-trace"})," for more)"]})]}),(0,n.jsxs)(g,{children:[(0,n.jsx)("h2",{children:"Stats display"}),(0,n.jsx)("small",{children:"(summarize the count of DB queries for a HTTP request)"})]}),(0,n.jsxs)(g,{children:[(0,n.jsxs)("h2",{children:["Gem ",(0,n.jsx)("b",{children:"active_record_query_stats"})]}),(0,n.jsx)(l.I,{children:"Query Stats\n-----------\ntotal: 6, real: 5, cached: 1\nselect: 4, insert: 0, update: 1, delete: 0\ntransaction: 0, savepoint: 0, lock: 0, rollback: 0, other: 0"}),(0,n.jsxs)("small",{children:["(see ",(0,n.jsx)("a",{href:"https://github.com/tian-im/active_record_query_stats",children:"active_record_query_stats"})," for more)"]})]}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"ActiveRecord Associations"}),(0,n.jsx)(l.I,{children:"user.messages"})]}),(0,n.jsx)(t.M,{children:(0,n.jsxs)("h2",{children:["\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d",(0,n.jsx)("br",{}),"No more ",(0,n.jsx)("br",{}),"SQL hand-crafting",(0,n.jsx)("br",{}),"\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d\ud83d\udc4d"]})}),(0,n.jsxs)(b,{children:[(0,n.jsx)("h2",{children:"It comes with a cost"}),(0,n.jsx)(l.I,{children:"users.each do |user|\n  user.messages # triggers a db query\nend"}),(0,n.jsx)("b",{className:"fragment fade-in",children:"(Database IO operation)"})]}),(0,n.jsx)(b,{children:(0,n.jsx)("h2",{children:(0,n.jsx)("b",{children:"AKA N+1 queries"})})}),(0,n.jsxs)(p,{children:[(0,n.jsxs)("h2",{children:["Preload associations for a ",(0,n.jsx)("b",{children:"scope"})]}),(0,n.jsxs)("small",{children:["(see ",(0,n.jsx)("a",{href:"http://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-includes",target:"_blank",children:"#includes"}),")"]}),(0,n.jsx)(l.I,{children:"User.includes(:messages).first(10)"})]}),(0,n.jsxs)(p,{children:[(0,n.jsxs)("h2",{children:["Set ",(0,n.jsx)("b",{children:":inverse_of"})]}),(0,n.jsxs)("small",{children:["(see ",(0,n.jsx)("a",{href:"https://guides.rubyonrails.org/association_basics.html#bi-directional-associations",children:"Bi-directional Associations"}),")"]}),(0,n.jsx)(l.I,{children:'User.has_many :messages, inverse_of: :recipient\n\nMessage.belongs_to(\n  :recipient, class_name: "User", foreign_key: :user_id\n)\n\nmessage = user.messages.first\nmessage.recipient # => no db query triggered'})]}),(0,n.jsxs)(p,{children:[(0,n.jsxs)("h2",{children:["Cache the records using ",(0,n.jsx)("b",{children:"cache_key_with_version"})]}),(0,n.jsxs)("small",{children:["(see ",(0,n.jsx)("a",{href:"http://api.rubyonrails.org/classes/ActiveRecord/Integration.html#method-i-cache_key_with_version",children:"#cache_key_with_version"}),")"]}),(0,n.jsx)(l.I,{children:'\nuser.cache_key_with_version # => "users/1-20220707132228762716"\n\nRails.cache.fetch user.cache_key_with_version do\n  user.messages\nend\n\nuser.touch # updated_at is changed\nuser.cache_key_with_version # => "users/1-20220809051121153710"'})]}),(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Use foreign_key"}),(0,n.jsx)("small",{children:"(Avoid using association)"}),(0,n.jsx)(l.I,{children:"message.user_id == user.id\n\n# instead of\nmessage.recipient == user"})]}),(0,n.jsxs)(p,{children:[(0,n.jsxs)("h2",{children:["Preload association for an ",(0,n.jsx)("b",{children:"array"})]}),(0,n.jsx)(l.I,{children:"# Rails 6\nActiveRecord::Associations::Preloader\n  .new.preload(user_array, :messages)\n\n# Rails 7\nActiveRecord::Associations::Preloader\n  .new(records: user_array, associations: :messages).call\n\nuser_array.first.messages # won't trigger db query"})]}),(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Preload association using existing records"}),(0,n.jsx)(l.I,{children:"user.association('messages').target = existing_message_array\n\nuser.messages # won't trigger db query"})]}),(0,n.jsxs)(p,{children:[(0,n.jsxs)("h2",{children:["Reuse existing association ",(0,n.jsx)("br",{}),"and use ",(0,n.jsx)("b",{children:".find"})]}),(0,n.jsxs)("small",{children:["(instead of using ",(0,n.jsx)("b",{children:".exists?"})," query)"]}),(0,n.jsx)(l.I,{children:"# only when association data set is small\nuser.messages.find { |m| m.title == '...' }\n\n# instead of\nuser.messages.exists?(title: '...')"})]}),(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Reset when stale"}),(0,n.jsx)(l.I,{children:"Message.create!(user: user, title: 'new message')\n\nuser.messages.reset if user.messages.loaded?\n\nuser.messages # will pull down the latest records"})]}),(0,n.jsx)(m,{})]})},j=function(){return(0,n.jsxs)(t.M,{children:[(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"Database Statement"}),(0,n.jsx)("small",{children:"(this talk focuses on PostgreSQL)"})]}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"EXPLAIN ANALYZE"}),(0,n.jsx)("small",{children:"(run it on the data size similar to production)"})]}),(0,n.jsx)(t.M,{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"Types"}),(0,n.jsx)("li",{children:"Rows"}),(0,n.jsx)("li",{children:"Buffers"}),(0,n.jsx)("li",{children:"Loops"})]})}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"Database Statement"}),(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"Queries"}),(0,n.jsx)("li",{children:"Views"}),(0,n.jsx)("li",{children:"Data Manipulation"}),(0,n.jsxs)("li",{children:["Others",(0,n.jsx)("div",{children:(0,n.jsx)("small",{children:"Transactions/Save Points, Functions, Triggers"})})]})]})]}),(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Queries"}),(0,n.jsxs)("ul",{children:[(0,n.jsxs)("li",{children:["Add proper index for ",(0,n.jsx)("b",{children:"Column"}),"/",(0,n.jsx)("b",{children:"Expression"}),(0,n.jsx)("div",{children:(0,n.jsx)("small",{children:"B-Tree, Hash-Tree, GIN (full text search), and etc."})})]}),(0,n.jsx)("li",{children:"Select just the required columns"}),(0,n.jsx)("li",{children:"Others"})]})]}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"View vs Materialized View"}),(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"View is a shorter version of query that indexes can't be added."}),(0,n.jsx)("li",{children:"Materialized view is more like an actual table that indexes can be added."})]})]}),(0,n.jsxs)(b,{children:[(0,n.jsx)("h2",{children:"Insert/Update/Delete is Slow!"}),(0,n.jsxs)("ul",{children:[(0,n.jsxs)("li",{children:["Validation",(0,n.jsx)("div",{children:(0,n.jsx)("small",{children:"Not Null, Unique, Primary Key, Foreign Key, Default, Data Type, and etc."})})]}),(0,n.jsx)("li",{children:"Write to the table"}),(0,n.jsx)("li",{children:"Update indexes"}),(0,n.jsx)("li",{children:"Fire triggers"}),(0,n.jsxs)("li",{children:["Others",(0,n.jsx)("div",{children:(0,n.jsx)("small",{children:"Update table inheritance/partitions, and etc."})})]})]})]}),(0,n.jsx)(p,{children:(0,n.jsx)("h2",{children:"Batch Insert/Update/Delete"})}),(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Redis is Faster"}),(0,n.jsxs)("small",{children:["(For example, use ",(0,n.jsx)("b",{children:"Sidekiq"})," over ",(0,n.jsx)("b",{children:"DelayedJob"}),".)"]})]}),(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Remove/Disable if not needed."}),(0,n.jsxs)("small",{children:["(For example, disable ",(0,n.jsx)("b",{children:"PaperTrail"}),".)"]})]}),(0,n.jsx)(m,{})]})},x=function(){return(0,n.jsxs)(t.M,{children:[(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"GraphQL"}),(0,n.jsx)(l.d,{children:"query Example {\n  users {\n    messages {\n      body\n    }\n  }\n}"})]}),(0,n.jsxs)(t.M,{children:[(0,n.jsx)("h2",{children:"Data Loader"}),(0,n.jsx)(l.I,{children:"class AssociationLoader < RecordLoader\n  def perform(objects)\n    Preloader.includes(objects, @options || @model)\n    objects.each { | object | fulfill(object, object.try(@model)) }\n  end\nend"})]})]})},f=function(){return(0,n.jsxs)(t.M,{children:[(0,n.jsx)(t.M,{children:(0,n.jsx)("h2",{children:"Summary"})}),(0,n.jsx)(m,{})]})},m=function(){return(0,n.jsxs)(p,{children:[(0,n.jsx)("h2",{children:"Optimization Strategies"}),(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"Minimize the no. of IO"}),(0,n.jsx)("li",{children:"Re-use/cache the data"}),(0,n.jsx)("li",{children:"Use faster alternatives"})]})]})},b=function(e){var s=e.children;return(0,n.jsx)(t.M,{className:"problem",children:s})},g=function(e){var s=e.children;return(0,n.jsx)(t.M,{className:"tool",children:s})},p=function(e){var s=e.children;return(0,n.jsx)(t.M,{className:"optimization",children:s})}},2165:function(e,s,r){"use strict";r.d(s,{I:function(){return a},d:function(){return c}});var n=r(5893);function i(e,s,r){return s in e?Object.defineProperty(e,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[s]=r,e}function l(e){for(var s=1;s<arguments.length;s++){var r=null!=arguments[s]?arguments[s]:{},n=Object.keys(r);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(s){i(e,s,r[s])}))}return e}function t(e,s){if(null==e)return{};var r,n,i=function(e,s){if(null==e)return{};var r,n,i={},l=Object.keys(e);for(n=0;n<l.length;n++)r=l[n],s.indexOf(r)>=0||(i[r]=e[r]);return i}(e,s);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)r=l[n],s.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var c=function(e){var s=e.children,r=e.lang,i=t(e,["children","lang"]);return(0,n.jsx)("pre",{children:(0,n.jsx)("code",l({className:r},i,{children:s}))})},a=function(e){var s=e.children;t(e,["children"]);return(0,n.jsx)(c,{lang:"rb",children:s})}},8142:function(e,s,r){"use strict";r(5893)},3344:function(e,s,r){"use strict";r.d(s,{A:function(){return o}});var n=r(4051),i=r.n(n),l=r(5893),t=r(7294);function c(e,s,r,n,i,l,t){try{var c=e[l](t),a=c.value}catch(d){return void r(d)}c.done?s(a):Promise.resolve(a).then(n,i)}function a(e,s,r){return s in e?Object.defineProperty(e,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[s]=r,e}function d(e){for(var s=1;s<arguments.length;s++){var r=null!=arguments[s]?arguments[s]:{},n=Object.keys(r);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(s){a(e,s,r[s])}))}return e}function h(e,s){if(null==e)return{};var r,n,i=function(e,s){if(null==e)return{};var r,n,i={},l=Object.keys(e);for(n=0;n<l.length;n++)r=l[n],s.indexOf(r)>=0||(i[r]=e[r]);return i}(e,s);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)r=l[n],s.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var o=function(e){var s=e.children,n=h(e,["children"]),a=n.handleSlideChanged,o=n.handleSlideTransitionEnd;return(0,t.useEffect)((function(){var e=function(){var e,s=(e=i().mark((function e(){var s,l,t,c,h,u,j,x,f;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(838).then(r.bind(r,3838));case 2:return s=e.sent,l=s.default,e.next=6,r.e(715).then(r.bind(r,2715));case 6:return t=e.sent,c=t.default,e.next=10,r.e(881).then(r.bind(r,9755));case 10:return h=e.sent,u=h.default,e.next=14,r.e(68).then(r.bind(r,1068));case 14:j=e.sent,x=j.default,(f=new l(d({plugins:[c,u,x],slideNumber:"c"},n))).initialize(),a&&f.on("slidechanged",a),o&&f.on("slidetransitionend",o);case 20:case"end":return e.stop()}}),e)})),function(){var s=this,r=arguments;return new Promise((function(n,i){var l=e.apply(s,r);function t(e){c(l,n,i,t,a,"next",e)}function a(e){c(l,n,i,t,a,"throw",e)}t(void 0)}))});return function(){return s.apply(this,arguments)}}();e()})),(0,l.jsx)("div",{className:"reveal",children:(0,l.jsx)("div",{className:"slides",children:s})})}},7890:function(e,s,r){"use strict";r.d(s,{M:function(){return t}});var n=r(5893);function i(e,s,r){return s in e?Object.defineProperty(e,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[s]=r,e}function l(e,s){if(null==e)return{};var r,n,i=function(e,s){if(null==e)return{};var r,n,i={},l=Object.keys(e);for(n=0;n<l.length;n++)r=l[n],s.indexOf(r)>=0||(i[r]=e[r]);return i}(e,s);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)r=l[n],s.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var t=function(e){var s=e.children,r=l(e,["children"]);return(0,n.jsx)("section",function(e){for(var s=1;s<arguments.length;s++){var r=null!=arguments[s]?arguments[s]:{},n=Object.keys(r);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(s){i(e,s,r[s])}))}return e}({},r,{children:s}))}}},function(e){e.O(0,[774,888,179],(function(){return s=7881,e(e.s=s);var s}));var s=e.O();_N_E=s}]);