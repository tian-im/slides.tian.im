<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/95c79f254a34be37.css" as="style"/><link rel="stylesheet" href="/_next/static/css/95c79f254a34be37.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-36df366cdb00b1ed.js" defer=""></script><script src="/_next/static/chunks/framework-1f10003e17636e37.js" defer=""></script><script src="/_next/static/chunks/main-f962425130346e35.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f607ca6186fcd0fb.js" defer=""></script><script src="/_next/static/chunks/pages/speed-up-rails-6fb4deec18719c09.js" defer=""></script><script src="/_next/static/i3keH6E_DjFfnMQe2v5GO/_buildManifest.js" defer=""></script><script src="/_next/static/i3keH6E_DjFfnMQe2v5GO/_ssgManifest.js" defer=""></script><script src="/_next/static/i3keH6E_DjFfnMQe2v5GO/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div class="reveal"><div class="slides"><section><h1>Speed Up Rails</h1><h2>@tian_im</h2></section><section><section><h2>How Performance is Ranked</h2></section><section><h2>Classify Tasks</h2></section><section><ul><li>Bugs</li><li>Features</li><li>Tech Debts<!-- --><div class="fragment fade-in"><small>â†‘ Performance issues</small></div></li></ul></section><section><h2>Code Quality</h2></section><section><img src="save-our-rails/code-quality-radar.png"/></section><section><h2>Performance Degrades</h2><small>(same as test coverage)</small></section><section><h2>Take It Seriously!</h2></section><section><h2>Before It Becomes a Problem</h2></section><section><ul><li>Server crashes</li><li>Raise funds, esp. before IPO</li></ul></section></section><section><section><h2>Understand the Performance</h2></section><section><h2>The No.1 Enemy</h2><h2 class="fragment fade-in"><b>Repetition</b></h2><pre><code class="rb">pry(main)&gt; puts Benchmark.measure { 1_000_000.times { a = &#x27;&#x27; } }
  0.134198   0.020083   0.154281 (  0.154829)
=&gt; nil</code></pre></section><section><h2>What is Slow?</h2></section><section><ul class="plain"><li><label class="checkbox-wrapper"><input type="checkbox"/></label>Ruby<!-- --></li><li><label class="checkbox-wrapper"><input type="checkbox"/></label>Rails<!-- --></li><li><label class="checkbox-wrapper"><input type="checkbox"/></label>Database queries<!-- --></li><li><label class="checkbox-wrapper"><input type="checkbox"/></label>All of Above<!-- --></li></ul></section><section><h2>IO is Slow!</h2><ul><li>File IO</li><li>Network IO<!-- --><div><small>Database queries, API requests</small></div></li></ul></section><section class="optimization"><h2>Optimization Strategies</h2><ul><li>Minimize the no. of IO</li><li>Re-use/cache the data</li><li>Use faster alternatives</li></ul></section><section><h2>Key Areas</h2></section><section><ul><li>ActiveRecord</li><li>Database Statement</li><li>GraphQL</li><li class="fragment fade-out" data-fragment-index="2">Database Schema</li><li class="fragment fade-out" data-fragment-index="2">Ruby: Object Allocation and Garbage Collect</li><li class="fragment fade-out" data-fragment-index="2">Rails</li><li class="fragment fade-out" data-fragment-index="2">Hierarchy</li></ul></section></section><section><section><h2>ActiveRecord</h2></section><section class="tool"><h2>Backtrace display</h2><small>(find out where the DB query was triggered)</small></section><section class="tool"><h2>Gem <!-- --><b>active_record_query_trace</b></h2><img src="/save-our-rails/active_record_query_trace.png"/><small>(see <!-- --><a href="https://github.com/brunofacca/active-record-query-trace">active-record-query-trace</a> for more)<!-- --></small></section><section class="tool"><h2>Stats display</h2><small>(summarize the count of DB queries for a HTTP request)</small></section><section class="tool"><h2>Gem <!-- --><b>active_record_query_stats</b></h2><pre><code class="rb">Query Stats
-----------
total: 6, real: 5, cached: 1
select: 4, insert: 0, update: 1, delete: 0
transaction: 0, savepoint: 0, lock: 0, rollback: 0, other: 0</code></pre><small>(see <!-- --><a href="https://github.com/tian-im/active_record_query_stats">active_record_query_stats</a> for more)<!-- --></small></section><section><h2>ActiveRecord Associations</h2><pre><code class="rb">user.messages</code></pre></section><section><h2>ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘<!-- --><br/>No more <!-- --><br/>SQL hand-crafting<!-- --><br/>ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘<!-- --></h2></section><section class="problem"><h2>It comes with a cost</h2><pre><code class="rb">users.each do |user|
  user.messages # triggers a db query
end</code></pre><b class="fragment fade-in">(Database IO operation)</b></section><section class="problem"><h2><b>AKA N+1 queries</b></h2></section><section class="optimization"><h2>Preload associations for a <!-- --><b>scope</b></h2><small>(see <!-- --><a href="http://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-includes" target="_blank">#includes</a>)<!-- --></small><pre><code class="rb">User.includes(:messages).first(10)</code></pre></section><section class="optimization"><h2>Set <!-- --><b>:inverse_of</b></h2><small>(see <!-- --><a href="https://guides.rubyonrails.org/association_basics.html#bi-directional-associations">Bi-directional Associations</a>)<!-- --></small><pre><code class="rb">User.has_many :messages, inverse_of: :recipient

Message.belongs_to(
  :recipient, class_name: &quot;User&quot;, foreign_key: :user_id
)

message = user.messages.first
message.recipient # =&gt; no db query triggered</code></pre></section><section class="optimization"><h2>Cache the records using <!-- --><b>cache_key_with_version</b></h2><small>(see <!-- --><a href="http://api.rubyonrails.org/classes/ActiveRecord/Integration.html#method-i-cache_key_with_version">#cache_key_with_version</a>)<!-- --></small><pre><code class="rb">
user.cache_key_with_version # =&gt; &quot;users/1-20220707132228762716&quot;

Rails.cache.fetch user.cache_key_with_version do
  user.messages
end

user.touch # updated_at is changed
user.cache_key_with_version # =&gt; &quot;users/1-20220809051121153710&quot;</code></pre></section><section class="optimization"><h2>Use foreign_key</h2><small>(Avoid using association)</small><pre><code class="rb">message.user_id == user.id

# instead of
message.recipient == user</code></pre></section><section class="optimization"><h2>Preload association for an <!-- --><b>array</b></h2><pre><code class="rb"># Rails 6
ActiveRecord::Associations::Preloader
  .new.preload(user_array, :messages)

# Rails 7
ActiveRecord::Associations::Preloader
  .new(records: user_array, associations: :messages).call

user_array.first.messages # won&#x27;t trigger db query</code></pre></section><section class="optimization"><h2>Preload association using existing records</h2><pre><code class="rb">user.association(&#x27;messages&#x27;).target = existing_message_array

user.messages # won&#x27;t trigger db query</code></pre></section><section class="optimization"><h2>Reuse existing association <!-- --><br/>and use <!-- --><b>.find</b></h2><small>(instead of using <!-- --><b>.exists?</b> query)<!-- --></small><pre><code class="rb"># only when association data set is small
user.messages.find { |m| m.title == &#x27;...&#x27; }

# instead of
user.messages.exists?(title: &#x27;...&#x27;)</code></pre></section><section class="optimization"><h2>Reset when stale</h2><pre><code class="rb">Message.create!(user: user, title: &#x27;new message&#x27;)

user.messages.reset if user.messages.loaded?

user.messages # will pull down the latest records</code></pre></section><section class="optimization"><h2>Optimization Strategies</h2><ul><li>Minimize the no. of IO</li><li>Re-use/cache the data</li><li>Use faster alternatives</li></ul></section></section><section><section><h2>Database Statement</h2><small>(this talk focuses on PostgreSQL)</small></section><section><h2>EXPLAIN ANALYZE</h2><small>(run it on the data size similar to production)</small></section><section><ul><li>Types</li><li>Rows</li><li>Buffers</li><li>Loops</li></ul></section><section><h2>Database Statement</h2><ul><li>Queries</li><li>Views</li><li>Data Manipulation</li><li>Others<!-- --><div><small>Transactions/Save Points, Functions, Triggers</small></div></li></ul></section><section class="optimization"><h2>Queries</h2><ul><li>Add proper index for <!-- --><b>Column</b>/<!-- --><b>Expression</b><div><small>B-Tree, Hash-Tree, GIN (full text search), and etc.</small></div></li><li>Select just the required columns</li><li>Others</li></ul></section><section><h2>View vs Materialized View</h2><ul><li>View is a shorter version of query that indexes can&#x27;t be added.</li><li>Materialized view is more like an actual table that indexes can be added.</li></ul></section><section class="problem"><h2>Insert/Update/Delete is Slow!</h2><ul><li>Validation<!-- --><div><small>Not Null, Unique, Primary Key, Foreign Key, Default, Data Type, and etc.</small></div></li><li>Write to the table</li><li>Update indexes</li><li>Fire triggers</li><li>Others<!-- --><div><small>Update table inheritance/partitions, and etc.</small></div></li></ul></section><section class="optimization"><h2>Batch Insert/Update/Delete</h2></section><section class="optimization"><h2>Redis is Faster</h2><small>(For example, use <!-- --><b>Sidekiq</b> over <!-- --><b>DelayedJob</b>.)<!-- --></small></section><section class="optimization"><h2>Remove/Disable if not needed.</h2><small>(For example, disable <!-- --><b>PaperTrail</b>.)<!-- --></small></section><section class="optimization"><h2>Optimization Strategies</h2><ul><li>Minimize the no. of IO</li><li>Re-use/cache the data</li><li>Use faster alternatives</li></ul></section></section><section><section><h2>GraphQL</h2><pre><code>query Example {
  users {
    messages {
      body
    }
  }
}</code></pre></section><section><h2>Data Loader</h2><pre><code class="rb">class AssociationLoader &lt; RecordLoader
  def perform(objects)
    Preloader.includes(objects, @options || @model)
    objects.each { | object | fulfill(object, object.try(@model)) }
  end
end</code></pre></section></section><section><section><h2>Summary</h2></section><section class="optimization"><h2>Optimization Strategies</h2><ul><li>Minimize the no. of IO</li><li>Re-use/cache the data</li><li>Use faster alternatives</li></ul></section></section></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/speed-up-rails","query":{},"buildId":"i3keH6E_DjFfnMQe2v5GO","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>